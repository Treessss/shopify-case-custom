{%- liquid
  assign st = section.settings
  assign custom_product = all_products[st.product_handle]
  assign model_option_name = st.model_option_name | default: '型号'
  assign type_option_name = st.case_type_option_name | default: '壳类型'
  assign fallback_image = st.mockup_image | default: custom_product.featured_image
  assign canvas_w = st.canvas_width
  assign outside_alpha = st.outside_alpha | default: 25
  assign image_maps = section.blocks | where: 'type', 'base_image_map'
  assign stickers = section.blocks | where: 'sticker'
-%}
-%}
{%- liquid
  assign tr_title = 'case_customizer.title' | t
  if tr_title contains 'Translation missing' 
    assign tr_title = 'Please select the product to customize'
  endif
  assign tr_help = 'case_customizer.editor.help_select_product' | t
  if tr_help contains 'Translation missing'
    assign tr_help = 'Open the theme editor and set the product handle in this section'
  endif
  assign tr_hint_preview = 'case_customizer.hint_preview' | t
  if tr_hint_preview contains 'Translation missing'
    assign tr_hint_preview = 'Image and text overlay in real time; base image switches by model and case type'
  endif
  assign tr_field_model = 'case_customizer.field_model' | t
  if tr_field_model contains 'Translation missing'
    assign tr_field_model = 'Phone model'
  endif
  assign tr_field_case_type = 'case_customizer.field_case_type' | t
  if tr_field_case_type contains 'Translation missing'
    assign tr_field_case_type = 'Case type'
  endif
  assign tr_field_upload_image = 'case_customizer.field_upload_image' | t
  if tr_field_upload_image contains 'Translation missing'
    assign tr_field_upload_image = 'Upload image'
  endif
  assign tr_field_image_x = 'case_customizer.field_image_x' | t
  if tr_field_image_x contains 'Translation missing'
    assign tr_field_image_x = 'Image X (%)'
  endif
  assign tr_field_image_y = 'case_customizer.field_image_y' | t
  if tr_field_image_y contains 'Translation missing'
    assign tr_field_image_y = 'Image Y (%)'
  endif
  assign tr_field_image_scale = 'case_customizer.field_image_scale' | t
  if tr_field_image_scale contains 'Translation missing'
    assign tr_field_image_scale = 'Image scale (%)'
  endif
  assign tr_fit_mode_label = 'case_customizer.fit_mode_label' | t
  if tr_fit_mode_label contains 'Translation missing'
    assign tr_fit_mode_label = 'Fit mode'
  endif
  assign tr_fit_mode_cover = 'case_customizer.fit_mode_cover' | t
  if tr_fit_mode_cover contains 'Translation missing'
    assign tr_fit_mode_cover = 'Cover'
  endif
  assign tr_fit_mode_contain = 'case_customizer.fit_mode_contain' | t
  if tr_fit_mode_contain contains 'Translation missing'
    assign tr_fit_mode_contain = 'Contain'
  endif
  assign tr_fit_mode_stretch = 'case_customizer.fit_mode_stretch' | t
  if tr_fit_mode_stretch contains 'Translation missing'
    assign tr_fit_mode_stretch = 'Stretch'
  endif
  assign tr_auto_fit = 'case_customizer.auto_fit' | t
  if tr_auto_fit contains 'Translation missing'
    assign tr_auto_fit = 'Auto fit after upload'
  endif
  assign tr_clip_to_area = 'case_customizer.clip_to_area' | t
  if tr_clip_to_area contains 'Translation missing'
    assign tr_clip_to_area = 'Clip to printable area'
  endif
  assign tr_image_rotation = 'case_customizer.image_rotation' | t
  if tr_image_rotation contains 'Translation missing'
    assign tr_image_rotation = 'Rotation (°)'
  endif
  assign tr_field_text = 'case_customizer.field_text' | t
  if tr_field_text contains 'Translation missing'
    assign tr_field_text = 'Custom text'
  endif
  assign tr_field_text_placeholder = 'case_customizer.field_text_placeholder' | t
  if tr_field_text_placeholder contains 'Translation missing'
    assign tr_field_text_placeholder = 'Type your text'
  endif
  assign tr_field_text_x = 'case_customizer.field_text_x' | t
  if tr_field_text_x contains 'Translation missing'
    assign tr_field_text_x = 'Text X (%)'
  endif
  assign tr_field_text_y = 'case_customizer.field_text_y' | t
  if tr_field_text_y contains 'Translation missing'
    assign tr_field_text_y = 'Text Y (%)'
  endif
  assign tr_field_text_size = 'case_customizer.field_text_size' | t
  if tr_field_text_size contains 'Translation missing'
    assign tr_field_text_size = 'Text size'
  endif
  assign tr_field_text_color = 'case_customizer.field_text_color' | t
  if tr_field_text_color contains 'Translation missing'
    assign tr_field_text_color = 'Text color'
  endif
  assign tr_sticker_controls = 'case_customizer.sticker_controls' | t
  if tr_sticker_controls contains 'Translation missing'
    assign tr_sticker_controls = 'Sticker position and scale'
  endif
  assign tr_sticker_x = 'case_customizer.sticker_x' | t
  if tr_sticker_x contains 'Translation missing'
    assign tr_sticker_x = 'Sticker X (%)'
  endif
  assign tr_sticker_y = 'case_customizer.sticker_y' | t
  if tr_sticker_y contains 'Translation missing'
    assign tr_sticker_y = 'Sticker Y (%)'
  endif
  assign tr_sticker_scale = 'case_customizer.sticker_scale' | t
  if tr_sticker_scale contains 'Translation missing'
    assign tr_sticker_scale = 'Sticker scale (%)'
  endif
  assign tr_submit = 'case_customizer.submit_add_to_cart' | t
  if tr_submit contains 'Translation missing'
    assign tr_submit = 'Add to cart'
  endif
  assign tr_prop_image = 'case_customizer.property.image' | t
  if tr_prop_image contains 'Translation missing'
    assign tr_prop_image = 'Custom Image'
  endif
  assign tr_prop_image_x = 'case_customizer.property.image_x' | t
  if tr_prop_image_x contains 'Translation missing'
    assign tr_prop_image_x = 'Image X (%)'
  endif
  assign tr_prop_image_y = 'case_customizer.property.image_y' | t
  if tr_prop_image_y contains 'Translation missing'
    assign tr_prop_image_y = 'Image Y (%)'
  endif
  assign tr_prop_image_scale = 'case_customizer.property.image_scale' | t
  if tr_prop_image_scale contains 'Translation missing'
    assign tr_prop_image_scale = 'Image Scale (%)'
  endif
  assign tr_prop_text = 'case_customizer.property.text' | t
  if tr_prop_text contains 'Translation missing'
    assign tr_prop_text = 'Custom Text'
  endif
  assign tr_prop_text_x = 'case_customizer.property.text_x' | t
  if tr_prop_text_x contains 'Translation missing'
    assign tr_prop_text_x = 'Text X (%)'
  endif
  assign tr_prop_text_y = 'case_customizer.property.text_y' | t
  if tr_prop_text_y contains 'Translation missing'
    assign tr_prop_text_y = 'Text Y (%)'
  endif
  assign tr_prop_text_size = 'case_customizer.property.text_size' | t
  if tr_prop_text_size contains 'Translation missing'
    assign tr_prop_text_size = 'Text Size'
  endif
  assign tr_prop_text_color = 'case_customizer.property.text_color' | t
  if tr_prop_text_color contains 'Translation missing'
    assign tr_prop_text_color = 'Text Color'
  endif
  assign tr_prop_sticker_name = 'case_customizer.property.sticker_name' | t
  if tr_prop_sticker_name contains 'Translation missing'
    assign tr_prop_sticker_name = 'Sticker Name'
  endif
  assign tr_prop_sticker_x = 'case_customizer.property.sticker_x' | t
  if tr_prop_sticker_x contains 'Translation missing'
    assign tr_prop_sticker_x = 'Sticker X (%)'
  endif
  assign tr_prop_sticker_y = 'case_customizer.property.sticker_y' | t
  if tr_prop_sticker_y contains 'Translation missing'
    assign tr_prop_sticker_y = 'Sticker Y (%)'
  endif
  assign tr_prop_sticker_scale = 'case_customizer.property.sticker_scale' | t
  if tr_prop_sticker_scale contains 'Translation missing'
    assign tr_prop_sticker_scale = 'Sticker Scale (%)'
  endif
  assign tr_prop_fit_mode = 'case_customizer.property.fit_mode' | t
  if tr_prop_fit_mode contains 'Translation missing'
    assign tr_prop_fit_mode = 'Fit Mode'
  endif
  assign tr_prop_rotation = 'case_customizer.property.rotation' | t
  if tr_prop_rotation contains 'Translation missing'
    assign tr_prop_rotation = 'Rotation (deg)'
  endif
-%}
<style>
  .container { max-width: 1180px; margin: 0 auto; padding: 24px; }
  .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; }
  @media (max-width: 992px) { .grid { grid-template-columns: 1fr; gap: 16px; } }
  #preview-wrap { position: relative; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  .form { display: flex; flex-direction: column; gap: 14px; }
  .form label { font-size: 14px; color: #111; }
  .form select, .form input[type="text"], .form input[type="file"] { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background: #fff; transition: border-color .2s ease, box-shadow .2s ease; }
  .form select:focus, .form input[type="text"]:focus, .form input[type="file"]:focus { outline: none; border-color: #111; box-shadow: 0 0 0 3px rgba(17,17,17,0.1); }
  .form input[type="range"] { width: 100%; accent-color: #111; }
  .btn-primary { width: 100%; padding: 12px 14px; border: 0; border-radius: 10px; background: #111; color: #fff; font-weight: 600; transition: transform .12s ease, background .2s ease, box-shadow .2s ease; }
  .btn-primary:hover { background: #000; box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
  .btn-primary:active { transform: scale(0.98); }
  #sticker-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
  #sticker-list img { width: 64px; height: 64px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease; background: #fff; }
  #sticker-list img:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); border-color: #bbb; }
  #sticker-list img.active { border-color: #111; box-shadow: 0 0 0 3px rgba(17,17,17,0.12); }
</style>
{%- if custom_product == blank -%}
  <div class="container">
    <h2 style="margin:0 0 10px;">{{ tr_title }}</h2>
    <p>{{ tr_help }}</p>
  </div>
{%- else -%}
  <div class="container">
    <div class="grid">
      <div>
        <div id="preview-wrap" style="position:relative;">
          <canvas id="customizer-canvas" width="{{ canvas_w }}" height="{{ canvas_w }}"></canvas>
        </div>
        <div style="margin-top:10px;font-size:12px;color:#666;">{{ tr_hint_preview }}</div>
        <div id="sticker-list" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;">
          {%- for b in stickers -%}
            {%- if b.settings.image != blank -%}
              <img src="{{ b.settings.image | image_url: width: 160 }}" alt="" data-sticker="{{ forloop.index0 }}" style="width:60px;height:60px;object-fit:contain;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
      <div>
        {%- assign form_id = 'case-customizer-form-' | append: section.id -%}
        {%- form 'product', custom_product, id: form_id, class: 'form', novalidate: 'novalidate' -%}
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div>
              <label style="display:block;margin-bottom:6px;">{{ tr_field_model }}</label>
              <select id="select-model" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></select>
            </div>
            <div>
              <label style="display:block;margin-bottom:6px;">{{ tr_field_case_type }}</label>
              <select id="select-type" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></select>
            </div>
            <input type="hidden" name="id" id="variant-id">
            <div>
              <label style="display:block;margin-bottom:6px;">{{ tr_field_upload_image }}</label>
              <input id="input-image" type="file" accept="image/*" name="properties[{{ tr_prop_image }}]" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
              <input type="hidden" name="properties[{{ tr_prop_image_x }}]" id="prop-image-x">
              <input type="hidden" name="properties[{{ tr_prop_image_y }}]" id="prop-image-y">
              <input type="hidden" name="properties[{{ tr_prop_image_scale }}]" id="prop-image-scale">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_image_x }}</label><input id="image-x" type="range" min="0" max="100" value="50" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_image_y }}</label><input id="image-y" type="range" min="0" max="100" value="50" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_image_scale }}</label><input id="image-scale" type="range" min="10" max="200" value="100" style="width:100%;"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label style="display:block;margin-bottom:6px;">{{ tr_fit_mode_label }}</label>
                <select id="fit-mode" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
                  <option value="cover">{{ tr_fit_mode_cover }}</option>
                  <option value="contain">{{ tr_fit_mode_contain }}</option>
                  <option value="stretch">{{ tr_fit_mode_stretch }}</option>
                </select>
                <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
                  <label style="display:flex;gap:6px;align-items:center;">
                    <input id="auto-fit" type="checkbox" checked>
                    <span>{{ tr_auto_fit }}</span>
                  </label>
                  <label style="display:flex;gap:6px;align-items:center;">
                    <input id="clip-area" type="checkbox" checked>
                    <span>{{ tr_clip_to_area }}</span>
                  </label>
                </div>
              </div>
              <div>
                <label style="display:block;margin-bottom:6px;">{{ tr_image_rotation }}</label>
                <input id="image-rotation" type="range" min="-180" max="180" value="0" style="width:100%;">
              </div>
            </div>
            <input type="hidden" name="properties[{{ tr_prop_fit_mode }}]" id="prop-fit-mode">
            <input type="hidden" name="properties[{{ tr_prop_rotation }}]" id="prop-image-rotation">
            <div>
              <label style="display:block;margin-bottom:6px;">{{ tr_field_text }}</label>
              <input id="input-text" type="text" name="properties[{{ tr_prop_text }}]" placeholder="{{ tr_field_text_placeholder }}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
              <input type="hidden" name="properties[{{ tr_prop_text_x }}]" id="prop-text-x">
              <input type="hidden" name="properties[{{ tr_prop_text_y }}]" id="prop-text-y">
              <input type="hidden" name="properties[{{ tr_prop_text_size }}]" id="prop-text-size">
              <input type="hidden" name="properties[{{ tr_prop_text_color }}]" id="prop-text-color">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_text_x }}</label><input id="text-x" type="range" min="0" max="100" value="50" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_text_y }}</label><input id="text-y" type="range" min="0" max="100" value="50" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_text_size }}</label><input id="text-size" type="range" min="12" max="64" value="26" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">{{ tr_field_text_color }}</label><input id="text-color" type="color" value="#111111" style="width:100%;height:38px;border:1px solid #ddd;border-radius:6px;"></div>
            </div>
            <div>
              <label style="display:block;margin-bottom:6px;">{{ tr_sticker_controls }}</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="display:block;margin-bottom:6px;">{{ tr_sticker_x }}</label><input id="sticker-x" type="range" min="0" max="100" value="50" style="width:100%;"></div>
                <div><label style="display:block;margin-bottom:6px;">{{ tr_sticker_y }}</label><input id="sticker-y" type="range" min="0" max="100" value="50" style="width:100%;"></div>
                <div><label style="display:block;margin-bottom:6px;">{{ tr_sticker_scale }}</label><input id="sticker-scale" type="range" min="10" max="200" value="100" style="width:100%;"></div>
              </div>
              <input type="hidden" name="properties[{{ tr_prop_sticker_name }}]" id="prop-sticker-name">
              <input type="hidden" name="properties[{{ tr_prop_sticker_x }}]" id="prop-sticker-x">
              <input type="hidden" name="properties[{{ tr_prop_sticker_y }}]" id="prop-sticker-y">
              <input type="hidden" name="properties[{{ tr_prop_sticker_scale }}]" id="prop-sticker-scale">
            </div>
            <div><button type="submit" class="btn-primary">{{ tr_submit }}</button></div>
          </div>
          <input type="hidden" id="data-area-left" value="{{ st.area_left }}">
          <input type="hidden" id="data-area-top" value="{{ st.area_top }}">
          <input type="hidden" id="data-area-width" value="{{ st.area_width }}">
          <input type="hidden" id="data-area-height" value="{{ st.area_height }}">
        {%- endform -%}
      </div>
    </div>
  </div>

  <script>
    (function() {
      var canvas = document.getElementById('customizer-canvas');
      var ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      var baseImg = new Image();
      baseImg.crossOrigin = 'anonymous';
      var maskImg = new Image();
      maskImg.crossOrigin = 'anonymous';
      var hasMask = false;
      var frameImg = new Image();
      frameImg.crossOrigin = 'anonymous';
      var hasFrame = false;
      var imageMaps = [
        {%- for m in image_maps -%}
          {
            model: {{ m.settings.model_value | json }},
            type: {{ m.settings.case_type_value | json }},
            src: {{ m.settings.image | image_url: width: canvas_w | json }},
            mask: {{ m.settings.mask | image_url: width: canvas_w | json }},
            frame: {{ m.settings.frame | image_url: width: canvas_w | json }},
            left: {{ m.settings.area_left | default: st.area_left | json }},
            top: {{ m.settings.area_top | default: st.area_top | json }},
            width: {{ m.settings.area_width | default: st.area_width | json }},
            height: {{ m.settings.area_height | default: st.area_height | json }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ];
      var stickers = [
        {%- for s in stickers -%}
          {%- if s.settings.image != blank -%}
            { src: {{ s.settings.image | image_url: width: 600 | json }}, name: {{ s.settings.name | default: 'Sticker ' | append: forloop.index | json }} }
            {%- unless forloop.last -%},{%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      ];
      var areaLeftPct = parseFloat(document.getElementById('data-area-left').value || '10');
      var areaTopPct = parseFloat(document.getElementById('data-area-top').value || '10');
      var areaWidthPct = parseFloat(document.getElementById('data-area-width').value || '80');
      var areaHeightPct = parseFloat(document.getElementById('data-area-height').value || '80');
      var outsideAlpha = {{ outside_alpha | json }} / 100;
      var uploadInput = document.getElementById('input-image');
      var imgXInput = document.getElementById('image-x');
      var imgYInput = document.getElementById('image-y');
      var imgScaleInput = document.getElementById('image-scale');
      var textInput = document.getElementById('input-text');
      var textXInput = document.getElementById('text-x');
      var textYInput = document.getElementById('text-y');
      var textSizeInput = document.getElementById('text-size');
      var textColorInput = document.getElementById('text-color');
      var propImgX = document.getElementById('prop-image-x');
      var propImgY = document.getElementById('prop-image-y');
      var propImgScale = document.getElementById('prop-image-scale');
      var fitModeEl = document.getElementById('fit-mode');
      var autoFitEl = document.getElementById('auto-fit');
      var clipEl = document.getElementById('clip-area');
      var rotationEl = document.getElementById('image-rotation');
      var propFitMode = document.getElementById('prop-fit-mode');
      var propImageRotation = document.getElementById('prop-image-rotation');
      var propTextX = document.getElementById('prop-text-x');
      var propTextY = document.getElementById('prop-text-y');
      var propTextSize = document.getElementById('prop-text-size');
      var propTextColor = document.getElementById('prop-text-color');
      var stickerXInput = document.getElementById('sticker-x');
      var stickerYInput = document.getElementById('sticker-y');
      var stickerScaleInput = document.getElementById('sticker-scale');
      var propStickerName = document.getElementById('prop-sticker-name');
      var propStickerX = document.getElementById('prop-sticker-x');
      var propStickerY = document.getElementById('prop-sticker-y');
      var propStickerScale = document.getElementById('prop-sticker-scale');
      var selectModel = document.getElementById('select-model');
      var selectType = document.getElementById('select-type');
      var variantIdInput = document.getElementById('variant-id');

      var uploadedImg = new Image();
      var hasUploaded = false;
      var stickerImg = new Image();
      var hasSticker = false;

      function setAreaByMap(map) {
        if (!map) return;
        areaLeftPct = parseFloat(map.left);
        areaTopPct = parseFloat(map.top);
        areaWidthPct = parseFloat(map.width);
        areaHeightPct = parseFloat(map.height);
      }

      function resolveBaseImage(model, type) {
        var match = imageMaps.find(function(m){ return m.model === model && m.type === type; });
        if (match) {
          baseImg.src = match.src;
          setAreaByMap(match);
          hasMask = !!match.mask;
          hasFrame = !!match.frame;
          if (hasMask) { maskImg.onload = requestDraw; maskImg.src = match.mask; } else { maskImg.src = ''; }
          if (hasFrame) { frameImg.onload = requestDraw; frameImg.src = match.frame; } else { frameImg.src = ''; }
          return;
        }
        var v = findVariantByOptions(model, type);
        if (v && v.featured_media && v.featured_media.preview_image && v.featured_media.preview_image.src) {
          baseImg.src = v.featured_media.preview_image.src;
          setAreaByMap({left: {{ st.area_left }}, top: {{ st.area_top }}, width: {{ st.area_width }}, height: {{ st.area_height }}});
          hasMask = false; hasFrame = false; maskImg.src = ''; frameImg.src = '';
          return;
        }
        baseImg.src = {{ fallback_image | image_url: width: canvas_w | json }};
        setAreaByMap({left: {{ st.area_left }}, top: {{ st.area_top }}, width: {{ st.area_width }}, height: {{ st.area_height }}});
        hasMask = false; hasFrame = false; maskImg.src = ''; frameImg.src = '';
      }

      var rafPending = false;
      function requestDraw(){ if (!rafPending) { rafPending = true; requestAnimationFrame(function(){ rafPending = false; draw(); }); } }
      function draw() {
        var ratio = baseImg.width / baseImg.height || 1;
        var wrap = document.getElementById('preview-wrap');
        var cw = Math.min((wrap && wrap.clientWidth) || {{ canvas_w }}, {{ canvas_w }});
        canvas.width = cw;
        canvas.height = Math.round(canvas.width / ratio);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        ctx.save();
        ctx.strokeStyle = 'rgba(0,0,0,0.12)';
        ctx.setLineDash([6, 4]);
        ctx.lineWidth = 2;
        ctx.strokeRect(areaLeft, areaTop, areaW, areaH);
        ctx.restore();
        if (hasUploaded && uploadedImg.width) {
          var imgPctX = parseFloat(imgXInput.value || '50');
          var imgPctY = parseFloat(imgYInput.value || '50');
          var imgScalePct = parseFloat(imgScaleInput.value || '100');
          var aspect = uploadedImg.width / uploadedImg.height;
          var areaAspect = areaW / areaH;
          var mode = (fitModeEl && fitModeEl.value) || 'cover';
          propFitMode && (propFitMode.value = mode);

          var imgW, imgH;
          if (autoFitEl && autoFitEl.checked) {
            if (mode === 'contain') {
              if (aspect > areaAspect) { imgW = areaW; imgH = imgW / aspect; } else { imgH = areaH; imgW = imgH * aspect; }
            } else if (mode === 'cover') {
              if (aspect > areaAspect) { imgH = areaH; imgW = imgH * aspect; } else { imgW = areaW; imgH = imgW / aspect; }
            } else { imgW = areaW; imgH = areaH; }
            var computedScalePct = (imgW / areaW) * 100;
            imgScalePct = computedScalePct;
            imgScaleInput && (imgScaleInput.value = Math.round(computedScalePct));
            imgPctX = 50; imgPctY = 50;
            imgXInput && (imgXInput.value = 50);
            imgYInput && (imgYInput.value = 50);
          } else { imgW = areaW * (imgScalePct / 100); imgH = imgW / aspect; }

          var deg = rotationEl ? parseFloat(rotationEl.value || '0') : 0;
          propImageRotation && (propImageRotation.value = Math.round(deg));

          var comp = document.createElement('canvas');
          var compCtx = comp.getContext('2d');
          comp.width = Math.max(1, Math.round(areaW));
          comp.height = Math.max(1, Math.round(areaH));

          compCtx.clearRect(0, 0, comp.width, comp.height);
          compCtx.save();
          var lcX = comp.width * imgPctX / 100;
          var lcY = comp.height * imgPctY / 100;
          compCtx.translate(lcX, lcY);
          compCtx.rotate(deg * Math.PI / 180);
          compCtx.drawImage(uploadedImg, -imgW / 2, -imgH / 2, imgW, imgH);
          compCtx.restore();

          if (hasSticker && stickerImg.width) {
            var sxPct = parseFloat(stickerXInput.value || '50');
            var syPct = parseFloat(stickerYInput.value || '50');
            var ssPct = parseFloat(stickerScaleInput.value || '100');
            var sw = comp.width * (ssPct / 100);
            var sh = sw * (stickerImg.height / stickerImg.width);
            var scx = comp.width * sxPct / 100;
            var scy = comp.height * syPct / 100;
            compCtx.drawImage(stickerImg, scx - sw / 2, scy - sh / 2, sw, sh);
          }

          var textVal = textInput.value || '';
          if (textVal.length) {
            var txPct = parseFloat(textXInput.value || '50');
            var tyPct = parseFloat(textYInput.value || '50');
            var tSize = parseInt(textSizeInput.value || '26', 10);
            var tColor = textColorInput.value || '#111111';
            var tx = comp.width * txPct / 100;
            var ty = comp.height * tyPct / 100;
            compCtx.save();
            compCtx.fillStyle = tColor;
            compCtx.textAlign = 'center';
            compCtx.textBaseline = 'middle';
            compCtx.font = tSize + 'px sans-serif';
            compCtx.fillText(textVal, tx, ty);
            compCtx.restore();
            propTextX.value = txPct.toFixed(2);
            propTextY.value = tyPct.toFixed(2);
            propTextSize.value = tSize;
            propTextColor.value = tColor;
          }

          if (hasMask && maskImg.width) {
            compCtx.globalCompositeOperation = 'destination-in';
            compCtx.drawImage(maskImg, 0, 0, comp.width, comp.height);
            compCtx.globalCompositeOperation = 'source-over';
          } else if (clipEl && clipEl.checked) {
            compCtx.globalCompositeOperation = 'destination-in';
            var rectMask = document.createElement('canvas');
            rectMask.width = comp.width; rectMask.height = comp.height;
            var rm = rectMask.getContext('2d');
            rm.fillStyle = '#000'; rm.fillRect(0,0,comp.width, comp.height);
            compCtx.drawImage(rectMask, 0,0);
            compCtx.globalCompositeOperation = 'source-over';
          }

          if (outsideAlpha > 0) {
            ctx.save();
            ctx.globalAlpha = outsideAlpha;
            var imgXAbs = areaLeft + comp.width * imgPctX / 100 - imgW / 2;
            var imgYAbs = areaTop + comp.height * imgPctY / 100 - imgH / 2;
            var cx = imgXAbs + imgW / 2; var cy = imgYAbs + imgH / 2;
            ctx.translate(cx, cy);
            ctx.rotate(deg * Math.PI / 180);
            ctx.drawImage(uploadedImg, -imgW / 2, -imgH / 2, imgW, imgH);
            ctx.restore();
          }

          ctx.drawImage(comp, areaLeft, areaTop);

          if (hasFrame && frameImg.width) {
            ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
          }

          propImgX.value = imgPctX.toFixed(2);
          propImgY.value = imgPctY.toFixed(2);
          propImgScale.value = parseFloat(imgScalePct).toFixed(2);
        }
        var textVal = textInput.value || '';
        if (textVal.length) {
          var txPct = parseFloat(textXInput.value || '50');
          var tyPct = parseFloat(textYInput.value || '50');
          var tSize = parseInt(textSizeInput.value || '26', 10);
          var tColor = textColorInput.value || '#111111';
          var tx = areaLeft + areaW * txPct / 100;
          var ty = areaTop + areaH * tyPct / 100;
          ctx.save();
          ctx.fillStyle = tColor;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.font = tSize + 'px sans-serif';
          ctx.fillText(textVal, tx, ty);
          ctx.restore();
          propTextX.value = txPct.toFixed(2);
          propTextY.value = tyPct.toFixed(2);
          propTextSize.value = tSize;
          propTextColor.value = tColor;
        }
        if (hasSticker && stickerImg.width) {
          propStickerX.value = (parseFloat(stickerXInput.value || '50')).toFixed(2);
          propStickerY.value = (parseFloat(stickerYInput.value || '50')).toFixed(2);
          propStickerScale.value = (parseFloat(stickerScaleInput.value || '100')).toFixed(2);
        }
      }

      baseImg.onload = requestDraw;

      function findVariantByOptions(model, type) {
        var variants = {{ custom_product.variants | json }};
        var optNames = {{ custom_product.options | json }};
        var idxModel = optNames.indexOf({{ model_option_name | json }});
        var idxType = optNames.indexOf({{ type_option_name | json }});
        return variants.find(function(v){
          var ok = true;
          if (idxModel === 0 && v.option1 !== model) ok = false;
          if (idxModel === 1 && v.option2 !== model) ok = false;
          if (idxModel === 2 && v.option3 !== model) ok = false;
          if (idxType === 0 && v.option1 !== type) ok = false;
          if (idxType === 1 && v.option2 !== type) ok = false;
          if (idxType === 2 && v.option3 !== type) ok = false;
          return ok;
        }) || null;
      }

      function initSelectors() {
        var opts = {{ custom_product.options_with_values | json }};
        var modelOpt = opts.find(function(o){ return o.name === {{ model_option_name | json }}; });
        var typeOpt = opts.find(function(o){ return o.name === {{ type_option_name | json }}; });
        selectModel.innerHTML = (modelOpt ? modelOpt.values : []).map(function(v){ return '<option>'+v+'</option>'; }).join('');
        selectType.innerHTML = (typeOpt ? typeOpt.values : []).map(function(v){ return '<option>'+v+'</option>'; }).join('');
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
      }

      uploadInput.addEventListener('change', function(e) {
        var f = e.target.files && e.target.files[0];
        if (!f) return;
        var url = URL.createObjectURL(f);
        uploadedImg.onload = function() { hasUploaded = true; requestDraw(); };
        uploadedImg.src = url;
      });

      document.getElementById('sticker-list').addEventListener('click', function(e){
        var idx = e.target && e.target.dataset && e.target.dataset.sticker;
        if (idx == null) return;
        var item = stickers[parseInt(idx, 10)];
        if (!item) return;
        stickerImg.onload = function(){ hasSticker = true; requestDraw(); };
        stickerImg.src = item.src;
        propStickerName.value = item.name;
        Array.prototype.forEach.call(document.querySelectorAll('#sticker-list img'), function(img){ img.classList.remove('active'); });
        if (e.target && e.target.tagName === 'IMG') { e.target.classList.add('active'); }
      });

      [imgXInput, imgYInput, imgScaleInput, textInput, textXInput, textYInput, textSizeInput, textColorInput, stickerXInput, stickerYInput, stickerScaleInput, fitModeEl, autoFitEl, clipEl, rotationEl].forEach(function(el) {
        el.addEventListener('input', requestDraw);
      });

      var dragging = false;
      var dragStart = null;
      var startPct = { x: 50, y: 50 };
      canvas.addEventListener('pointerdown', function(ev){
        if (!hasUploaded) return;
        var rect = canvas.getBoundingClientRect();
        var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        if (x < areaLeft || x > areaLeft + areaW || y < areaTop || y > areaTop + areaH) return;
        dragging = true; dragStart = { x: x, y: y };
        startPct.x = parseFloat(imgXInput.value || '50');
        startPct.y = parseFloat(imgYInput.value || '50');
        canvas.setPointerCapture(ev.pointerId);
      });
      canvas.addEventListener('pointermove', function(ev){
        if (!dragging) return;
        var rect = canvas.getBoundingClientRect();
        var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        var dx = x - dragStart.x; var dy = y - dragStart.y;
        var nx = Math.max(0, Math.min(100, startPct.x + (dx / areaW) * 100));
        var ny = Math.max(0, Math.min(100, startPct.y + (dy / areaH) * 100));
        imgXInput.value = nx.toFixed(2);
        imgYInput.value = ny.toFixed(2);
        requestDraw();
      });
      canvas.addEventListener('pointerup', function(){ dragging = false; });
      canvas.addEventListener('pointercancel', function(){ dragging = false; });

      canvas.addEventListener('wheel', function(ev){
        if (!hasUploaded) return;
        ev.preventDefault();
        var v = parseFloat(imgScaleInput.value || '100');
        var step = ev.deltaY > 0 ? -5 : 5;
        var nv = Math.max(10, Math.min(300, v + step));
        imgScaleInput.value = nv;
        requestDraw();
      }, { passive: false });

      var touchScale = null;
      canvas.addEventListener('touchstart', function(ev){
        if (ev.touches && ev.touches.length === 2) {
          var dx = ev.touches[0].clientX - ev.touches[1].clientX;
          var dy = ev.touches[0].clientY - ev.touches[1].clientY;
          touchScale = Math.sqrt(dx*dx + dy*dy);
        } else { touchScale = null; }
      }, { passive: true });
      canvas.addEventListener('touchmove', function(ev){
        if (!hasUploaded) return;
        if (ev.touches && ev.touches.length === 2 && touchScale) {
          var dx = ev.touches[0].clientX - ev.touches[1].clientX;
          var dy = ev.touches[0].clientY - ev.touches[1].clientY;
          var cur = Math.sqrt(dx*dx + dy*dy);
          var v = parseFloat(imgScaleInput.value || '100');
          var nv = Math.max(10, Math.min(300, v * (cur / touchScale)));
          imgScaleInput.value = Math.round(nv);
          touchScale = cur;
          requestDraw();
          ev.preventDefault();
        }
      }, { passive: false });

      selectModel.addEventListener('change', function(){
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
        requestDraw();
      });
      selectType.addEventListener('change', function(){
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
        requestDraw();
      });

      window.addEventListener('resize', requestDraw);
      document.addEventListener('visibilitychange', function(){ if (!document.hidden) requestDraw(); });

      baseImg.src = {{ fallback_image | image_url: width: canvas_w | json }};
      initSelectors();
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Case Customizer",
  "settings": [
    { "type": "text", "id": "product_handle", "label": "Product handle", "info": "Handle of the phone case product to customize" },
    { "type": "text", "id": "model_option_name", "label": "Model option name", "default": "Model" },
    { "type": "text", "id": "case_type_option_name", "label": "Case type option name", "default": "Case Type" },
    { "type": "image_picker", "id": "mockup_image", "label": "Default mockup image" },
    { "type": "range", "id": "outside_alpha", "label": "Outside preview opacity", "min": 0, "max": 80, "step": 5, "default": 25, "unit": "%" },
    { "type": "range", "id": "canvas_width", "label": "Canvas width", "min": 300, "max": 1200, "step": 50, "default": 700, "unit": "px" },
    { "type": "range", "id": "area_left", "label": "Printable area Left", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
    { "type": "range", "id": "area_top", "label": "Printable area Top", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
    { "type": "range", "id": "area_width", "label": "Printable area Width", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" },
    { "type": "range", "id": "area_height", "label": "Printable area Height", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" }
  ],
  "blocks": [
    {
      "type": "base_image_map",
      "name": "Base image mapping",
      "settings": [
        { "type": "text", "id": "model_value", "label": "Model value e.g. iPhone 15" },
        { "type": "text", "id": "case_type_value", "label": "Case type value e.g. Clear" },
        { "type": "image_picker", "id": "image", "label": "Base image" },
        { "type": "image_picker", "id": "mask", "label": "Mask image (transparent for holes/non-printable)" },
        { "type": "image_picker", "id": "frame", "label": "Frame overlay image (top realism layer)" },
        { "type": "range", "id": "area_left", "label": "Left offset for this combo", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
        { "type": "range", "id": "area_top", "label": "Top offset for this combo", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
        { "type": "range", "id": "area_width", "label": "Area width for this combo", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" },
        { "type": "range", "id": "area_height", "label": "Area height for this combo", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" }
      ]
    },
    {
      "type": "sticker",
      "name": "Sticker",
      "settings": [
        { "type": "text", "id": "name", "label": "Sticker name", "default": "Sticker" },
        { "type": "image_picker", "id": "image", "label": "Sticker image" }
      ]
    }
  ],
  "presets": [
    { "name": "Phone Case Customizer" }
  ]
}
{% endschema %}