{%- liquid
  assign st = section.settings
  assign custom_product = all_products[st.product_handle]
  assign model_option_name = st.model_option_name | default: '型号'
  assign type_option_name = st.case_type_option_name | default: '壳类型'
  assign fallback_image = st.mockup_image | default: custom_product.featured_image
  assign canvas_w = st.canvas_width
  assign outside_alpha = st.outside_alpha | default: 25
  assign image_maps = section.blocks | where: 'type', 'base_image_map'
  assign stickers = section.blocks | where: 'sticker'
-%}
{%- liquid
  assign tr_title = 'case_customizer.title' | t
  if tr_title contains 'Translation missing' 
    assign tr_title = 'Please select the product to customize'
  endif
  assign tr_help = 'case_customizer.editor.help_select_product' | t
  if tr_help contains 'Translation missing'
    assign tr_help = 'Open the theme editor and set the product handle in this section'
  endif
  assign tr_hint_preview = 'case_customizer.hint_preview' | t
  if tr_hint_preview contains 'Translation missing'
    assign tr_hint_preview = 'Image and text overlay in real time; base image switches by model and case type'
  endif
  assign tr_field_model = 'case_customizer.field_model' | t
  if tr_field_model contains 'Translation missing'
    assign tr_field_model = 'Phone model'
  endif
  assign tr_field_case_type = 'case_customizer.field_case_type' | t
  if tr_field_case_type contains 'Translation missing'
    assign tr_field_case_type = 'Case type'
  endif
  assign tr_field_upload_image = 'case_customizer.field_upload_image' | t
  if tr_field_upload_image contains 'Translation missing'
    assign tr_field_upload_image = 'Upload image'
  endif
  assign tr_field_image_x = 'case_customizer.field_image_x' | t
  if tr_field_image_x contains 'Translation missing'
    assign tr_field_image_x = 'Image X (%)'
  endif
  assign tr_field_image_y = 'case_customizer.field_image_y' | t
  if tr_field_image_y contains 'Translation missing'
    assign tr_field_image_y = 'Image Y (%)'
  endif
  assign tr_field_image_scale = 'case_customizer.field_image_scale' | t
  if tr_field_image_scale contains 'Translation missing'
    assign tr_field_image_scale = 'Image scale (%)'
  endif
  assign tr_fit_mode_label = 'case_customizer.fit_mode_label' | t
  if tr_fit_mode_label contains 'Translation missing'
    assign tr_fit_mode_label = 'Fit mode'
  endif
  assign tr_fit_mode_cover = 'case_customizer.fit_mode_cover' | t
  if tr_fit_mode_cover contains 'Translation missing'
    assign tr_fit_mode_cover = 'Cover'
  endif
  assign tr_fit_mode_contain = 'case_customizer.fit_mode_contain' | t
  if tr_fit_mode_contain contains 'Translation missing'
    assign tr_fit_mode_contain = 'Contain'
  endif
  assign tr_fit_mode_stretch = 'case_customizer.fit_mode_stretch' | t
  if tr_fit_mode_stretch contains 'Translation missing'
    assign tr_fit_mode_stretch = 'Stretch'
  endif
  assign tr_auto_fit = 'case_customizer.auto_fit' | t
  if tr_auto_fit contains 'Translation missing'
    assign tr_auto_fit = 'Auto fit after upload'
  endif
  assign tr_clip_to_area = 'case_customizer.clip_to_area' | t
  if tr_clip_to_area contains 'Translation missing'
    assign tr_clip_to_area = 'Clip to printable area'
  endif
  assign tr_image_rotation = 'case_customizer.image_rotation' | t
  if tr_image_rotation contains 'Translation missing'
    assign tr_image_rotation = 'Rotation (°)'
  endif
  assign tr_field_text = 'case_customizer.field_text' | t
  if tr_field_text contains 'Translation missing'
    assign tr_field_text = 'Custom text'
  endif
  assign tr_field_text_placeholder = 'case_customizer.field_text_placeholder' | t
  if tr_field_text_placeholder contains 'Translation missing'
    assign tr_field_text_placeholder = 'Type your text'
  endif
  assign tr_field_text_x = 'case_customizer.field_text_x' | t
  if tr_field_text_x contains 'Translation missing'
    assign tr_field_text_x = 'Text X (%)'
  endif
  assign tr_field_text_y = 'case_customizer.field_text_y' | t
  if tr_field_text_y contains 'Translation missing'
    assign tr_field_text_y = 'Text Y (%)'
  endif
  assign tr_field_text_size = 'case_customizer.field_text_size' | t
  if tr_field_text_size contains 'Translation missing'
    assign tr_field_text_size = 'Text size'
  endif
  assign tr_field_text_color = 'case_customizer.field_text_color' | t
  if tr_field_text_color contains 'Translation missing'
    assign tr_field_text_color = 'Text color'
  endif
  assign tr_sticker_controls = 'case_customizer.sticker_controls' | t
  if tr_sticker_controls contains 'Translation missing'
    assign tr_sticker_controls = 'Sticker position and scale'
  endif
  assign tr_sticker_x = 'case_customizer.sticker_x' | t
  if tr_sticker_x contains 'Translation missing'
    assign tr_sticker_x = 'Sticker X (%)'
  endif
  assign tr_sticker_y = 'case_customizer.sticker_y' | t
  if tr_sticker_y contains 'Translation missing'
    assign tr_sticker_y = 'Sticker Y (%)'
  endif
  assign tr_sticker_scale = 'case_customizer.sticker_scale' | t
  if tr_sticker_scale contains 'Translation missing'
    assign tr_sticker_scale = 'Sticker scale (%)'
  endif
  assign tr_submit = 'case_customizer.submit_add_to_cart' | t
  if tr_submit contains 'Translation missing'
    assign tr_submit = 'Add to cart'
  endif
  assign tr_prop_image = 'case_customizer.property.image' | t
  if tr_prop_image contains 'Translation missing'
    assign tr_prop_image = 'Custom Image'
  endif
  assign tr_prop_image_x = 'case_customizer.property.image_x' | t
  if tr_prop_image_x contains 'Translation missing'
    assign tr_prop_image_x = 'Image X (%)'
  endif
  assign tr_prop_image_y = 'case_customizer.property.image_y' | t
  if tr_prop_image_y contains 'Translation missing'
    assign tr_prop_image_y = 'Image Y (%)'
  endif
  assign tr_prop_image_scale = 'case_customizer.property.image_scale' | t
  if tr_prop_image_scale contains 'Translation missing'
    assign tr_prop_image_scale = 'Image Scale (%)'
  endif
  assign tr_prop_text = 'case_customizer.property.text' | t
  if tr_prop_text contains 'Translation missing'
    assign tr_prop_text = 'Custom Text'
  endif
  assign tr_prop_text_x = 'case_customizer.property.text_x' | t
  if tr_prop_text_x contains 'Translation missing'
    assign tr_prop_text_x = 'Text X (%)'
  endif
  assign tr_prop_text_y = 'case_customizer.property.text_y' | t
  if tr_prop_text_y contains 'Translation missing'
    assign tr_prop_text_y = 'Text Y (%)'
  endif
  assign tr_prop_text_size = 'case_customizer.property.text_size' | t
  if tr_prop_text_size contains 'Translation missing'
    assign tr_prop_text_size = 'Text Size'
  endif
  assign tr_prop_text_color = 'case_customizer.property.text_color' | t
  if tr_prop_text_color contains 'Translation missing'
    assign tr_prop_text_color = 'Text Color'
  endif
  assign tr_prop_sticker_name = 'case_customizer.property.sticker_name' | t
  if tr_prop_sticker_name contains 'Translation missing'
    assign tr_prop_sticker_name = 'Sticker Name'
  endif
  assign tr_prop_sticker_x = 'case_customizer.property.sticker_x' | t
  if tr_prop_sticker_x contains 'Translation missing'
    assign tr_prop_sticker_x = 'Sticker X (%)'
  endif
  assign tr_prop_sticker_y = 'case_customizer.property.sticker_y' | t
  if tr_prop_sticker_y contains 'Translation missing'
    assign tr_prop_sticker_y = 'Sticker Y (%)'
  endif
  assign tr_prop_sticker_scale = 'case_customizer.property.sticker_scale' | t
  if tr_prop_sticker_scale contains 'Translation missing'
    assign tr_prop_sticker_scale = 'Sticker Scale (%)'
  endif
  assign tr_prop_fit_mode = 'case_customizer.property.fit_mode' | t
  if tr_prop_fit_mode contains 'Translation missing'
    assign tr_prop_fit_mode = 'Fit Mode'
  endif
  assign tr_prop_rotation = 'case_customizer.property.rotation' | t
  if tr_prop_rotation contains 'Translation missing'
    assign tr_prop_rotation = 'Rotation (deg)'
  endif
  assign tr_tab_model = 'case_customizer.tab_model' | t
  if tr_tab_model contains 'Translation missing'
    assign tr_tab_model = 'Model'
  endif
  assign tr_tab_color = 'case_customizer.tab_color' | t
  if tr_tab_color contains 'Translation missing'
    assign tr_tab_color = 'Colour'
  endif
  assign tr_tab_pattern = 'case_customizer.tab_pattern' | t
  if tr_tab_pattern contains 'Translation missing'
    assign tr_tab_pattern = 'Pattern'
  endif
  assign tr_tab_image = 'case_customizer.tab_image' | t
  if tr_tab_image contains 'Translation missing'
    assign tr_tab_image = 'Image'
  endif
  assign tr_note_select_model = 'case_customizer.note_select_model' | t
  if tr_note_select_model contains 'Translation missing'
    assign tr_note_select_model = 'Select a model and case type to load the correct mockup'
  endif
  assign tr_btn_delete_image = 'case_customizer.btn_delete_image' | t
  if tr_btn_delete_image contains 'Translation missing'
    assign tr_btn_delete_image = 'Delete Image'
  endif
  assign tr_btn_upload_image = 'case_customizer.btn_upload_image' | t
  if tr_btn_upload_image contains 'Translation missing'
    assign tr_btn_upload_image = 'Upload Image'
  endif
  assign tr_image_state_none = 'case_customizer.image_state_none' | t
  if tr_image_state_none contains 'Translation missing'
    assign tr_image_state_none = 'No image selected'
  endif
  assign tr_image_state_selected = 'case_customizer.image_state_selected' | t
  if tr_image_state_selected contains 'Translation missing'
    assign tr_image_state_selected = 'Image selected'
  endif
  assign tr_btn_back = 'case_customizer.btn_back' | t
  if tr_btn_back contains 'Translation missing'
    assign tr_btn_back = 'Back'
  endif
  assign tr_btn_next = 'case_customizer.btn_next' | t
  if tr_btn_next contains 'Translation missing'
    assign tr_btn_next = 'Next'
  endif
-%}
<style>
  .container { max-width: min(1280px, 94vw); margin: 0 auto; padding: 24px; }
  .grid { display: grid; grid-template-columns: clamp(280px, 42vw, 520px) 1fr; gap: 24px; align-items: start; }
  @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; gap: 18px; } }
  @media (max-width: 640px) { .container { padding: 16px; } }
  #preview-wrap { position: relative; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  #preview-wrap canvas { width: 100%; height: auto; display: block; }
  .panel-card { border: 1px solid #e5e5e5; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); padding: 20px; }
  .panel-title { font-size: 26px; font-weight: 700; margin: 0 0 12px; }
  .tabs { display: flex; gap: 12px; margin-bottom: 14px; }
  .tab-btn { padding: 10px 14px; border: 1px solid #111; border-radius: 10px; background: #fff; font-weight: 600; }
  .tab-btn.active { color: #fff; background: #111; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .palette { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
  .swatch { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; box-shadow: inset 0 0 0 2px rgba(255,255,255,0.6); }
  .hex-row { display: flex; gap: 10px; align-items: center; margin-top: 12px; }
  .hex-input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
  .panel-note { font-size: 12px; color: #666; margin-top: 8px; }
  .sticky { position: sticky; top: 24px; }
  .form { display: flex; flex-direction: column; gap: 14px; }
  .form label { font-size: 14px; color: #111; }
  .form select, .form input[type="text"], .form input[type="file"] { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background: #fff; transition: border-color .2s ease, box-shadow .2s ease; }
  .form select:focus, .form input[type="text"]:focus, .form input[type="file"]:focus { outline: none; border-color: #111; box-shadow: 0 0 0 3px rgba(17,17,17,0.1); }
  .form input[type="range"] { width: 100%; accent-color: #111; }
  .btn-primary { width: 100%; padding: 12px 14px; border: 0; border-radius: 10px; background: #111; color: #fff; font-weight: 600; transition: transform .12s ease, background .2s ease, box-shadow .2s ease; }
  .btn-primary:hover { background: #000; box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
  .btn-primary:active { transform: scale(0.98); }
  #sticker-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
  #sticker-list img { width: 64px; height: 64px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease; background: #fff; }
  #sticker-list img:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); border-color: #bbb; }
  #sticker-list img.active { border-color: #111; box-shadow: 0 0 0 3px rgba(17,17,17,0.12); }
  .pattern-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
  .pattern-swatch { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
  .pattern-swatch.active { border-color: #111; box-shadow: 0 0 0 3px rgba(17,17,17,0.12); }
  .progress { height: 8px; border-radius: 999px; background: #f0f0f0; overflow: hidden; margin: 10px 0 14px; }
  .progress-bar { height: 100%; background: #111; width: 33%; transition: width .25s ease; }
  .step-nav { display:flex; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
  .btn-outline { width:auto; padding: 10px 14px; border: 1px solid #111; border-radius: 10px; background: #fff; color:#111; font-weight:600; }
  .btn-outline[disabled] { opacity: 0.5; cursor: not-allowed; }
</style>
{%- if custom_product == blank -%}
  <div class="container">
    <h2 style="margin:0 0 10px;">{{ tr_title }}</h2>
    <p>{{ tr_help }}</p>
  </div>
{%- else -%}
  <div class="container">
    <div class="grid">
      <div>
          <div id="preview-wrap" style="position:relative;">
          <canvas id="customizer-canvas" width="{{ canvas_w }}" height="{{ canvas_w }}"></canvas>
          <div id="preview-tools" style="position:absolute;top:8px;right:8px;display:flex;gap:8px;z-index:3;">
            <button id="btn-delete-image" type="button" class="btn-primary" style="padding:8px 10px;">{{ tr_btn_delete_image }}</button>
          </div>
        </div>
        <div style="margin-top:10px;font-size:12px;color:#666;">{{ tr_hint_preview }}</div>
        <div id="sticker-list" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;">
          {%- for b in stickers -%}
            {%- if b.settings.image != blank -%}
              <img src="{{ b.settings.image | image_url: width: 160 }}" alt="" data-sticker="{{ forloop.index0 }}" style="width:60px;height:60px;object-fit:contain;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
      <div>
        <div class="panel-card sticky">
          <div class="panel-title">Create a Phone Case</div>
          <div class="tabs">
            <button type="button" class="tab-btn active" data-tab="model">{{ tr_tab_model }}</button>
            <button type="button" class="tab-btn" data-tab="color">{{ tr_tab_color }}</button>
            <button type="button" class="tab-btn" data-tab="pattern">{{ tr_tab_pattern }}</button>
            <button type="button" class="tab-btn" data-tab="image">{{ tr_tab_image }}</button>
          </div>
          <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
          <div class="step-nav">
            <button id="btn-back" type="button" class="btn-outline">{{ tr_btn_back }}</button>
            <button id="btn-next" type="button" class="btn-primary" style="width:auto;">{{ tr_btn_next }}</button>
          </div>
          <div id="tab-model" class="tab-content active">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label style="display:block;margin-bottom:6px;">{{ tr_field_model }}</label>
                <select id="select-model" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></select>
              </div>
              <div>
                <label style="display:block;margin-bottom:6px;">{{ tr_field_case_type }}</label>
                <select id="select-type" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></select>
              </div>
            </div>
            <div class="panel-note">{{ tr_note_select_model }}</div>
          </div>
          <div id="tab-color" class="tab-content">
            <div class="palette" id="palette">
              <div class="swatch" data-color="#ffffff" style="background:#ffffff"></div>
              <div class="swatch" data-color="#f4f4f4" style="background:#f4f4f4"></div>
              <div class="swatch" data-color="#c9d66d" style="background:#c9d66d"></div>
              <div class="swatch" data-color="#2c3428" style="background:#2c3428"></div>
              <div class="swatch" data-color="#f6ead7" style="background:#f6ead7"></div>
              <div class="swatch" data-color="#ffd6df" style="background:#ffd6df"></div>
              <div class="swatch" data-color="#7c3f2c" style="background:#7c3f2c"></div>
              <div class="swatch" data-color="#f587c1" style="background:#f587c1"></div>
              <div class="swatch" data-color="#e7332b" style="background:#e7332b"></div>
              <div class="swatch" data-color="#6c1a1a" style="background:#6c1a1a"></div>
              <div class="swatch" data-color="#f2e6cf" style="background:#f2e6cf"></div>
              <div class="swatch" data-color="#ffef85" style="background:#ffef85"></div>
              <div class="swatch" data-color="#f7a01e" style="background:#f7a01e"></div>
              <div class="swatch" data-color="#9cc7ff" style="background:#9cc7ff"></div>
              <div class="swatch" data-color="#3045c7" style="background:#3045c7"></div>
              <div class="swatch" data-color="#7645ff" style="background:#7645ff"></div>
              <div class="swatch" data-color="#f2f2f2" style="background:#f2f2f2"></div>
              <div class="swatch" data-color="#cad5e5" style="background:#cad5e5"></div>
              <div class="swatch" data-color="#8291a7" style="background:#8291a7"></div>
              <div class="swatch" data-color="#101316" style="background:#101316"></div>
              <div class="swatch" data-color="#4b4f27" style="background:#4b4f27"></div>
              <div class="swatch" data-color="#472a25" style="background:#472a25"></div>
              <div class="swatch" data-color="#ffffff" style="background:#ffffff"></div>
              <div class="swatch" data-color="#000000" style="background:#000000"></div>
            </div>
            <div class="hex-row">
              <input id="color-hex" class="hex-input" value="#2C3428" />
            </div>
            <div class="panel-note">PLEASE NOTE THAT COLOURS MAY PRINT SLIGHTLY DARKER THAN THEY APPEAR ON SCREEN</div>
          </div>
          <div id="tab-pattern" class="tab-content">
            <div id="pattern-grid" class="pattern-grid">
              <div class="pattern-swatch" data-pattern="none" style="background:#f2f2f2"></div>
              <div class="pattern-swatch" data-pattern="stripes" style="background: repeating-linear-gradient(45deg, #111 0 10px, #fff 10px 20px);"></div>
              <div class="pattern-swatch" data-pattern="dots" style="background: radial-gradient(#111 18%, transparent 19%); background-size: 14px 14px; background-color:#fff;"></div>
              <div class="pattern-swatch" data-pattern="grid" style="background: repeating-linear-gradient(0deg, #111 0 1px, transparent 1px 20px), repeating-linear-gradient(90deg, #111 0 1px, transparent 1px 20px); background-color:#fff;"></div>
              <div class="pattern-swatch" data-pattern="crosshatch" style="background: repeating-linear-gradient(45deg, #111 0 1px, transparent 1px 12px), repeating-linear-gradient(-45deg, #111 0 1px, transparent 1px 12px); background-color:#fff;"></div>
              <div class="pattern-swatch" data-pattern="diagonal" style="background: repeating-linear-gradient(135deg, #111 0 6px, #fff 6px 12px);"></div>
              <div class="pattern-swatch" data-pattern="waves" style="background: radial-gradient(circle at 10px 10px, #fff 8px, transparent 9px), radial-gradient(circle at 40px 10px, #fff 8px, transparent 9px); background-size: 50px 20px; background-color:#111;"></div>
              <div class="pattern-swatch" data-pattern="honeycomb" style="background:#fff; border-style:dashed"></div>
              <div class="pattern-swatch" data-pattern="checker" style="background: conic-gradient(#111 0 25%, #fff 0 50%, #111 0 75%, #fff 0); background-size: 20px 20px;"></div>
              <div class="pattern-swatch" data-pattern="chevron" style="background:#fff; border-style:dashed"></div>
              <div class="pattern-swatch" data-pattern="herringbone" style="background:#fff; border-style:dashed"></div>
              <div class="pattern-swatch" data-pattern="terrazzo" style="background:#fff; border-style:dashed"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;">
              <div><label style="display:block;margin-bottom:6px;">PATTERN SCALE</label><input id="pattern-scale" type="range" min="50" max="200" value="100" style="width:100%;"></div>
              <div><label style="display:block;margin-bottom:6px;">PATTERN OPACITY</label><input id="pattern-opacity" type="range" min="0" max="100" value="30" style="width:100%;"></div>
            </div>
          </div>
          <div id="tab-image" class="tab-content">
            <div style="display:flex; gap:10px; align-items:center;">
            <button id="trigger-upload" type="button" class="btn-primary" style="width:auto; padding:10px 14px;">{{ tr_btn_upload_image }}</button>
            <div id="image-state" style="font-size:12px; color:#666;">{{ tr_image_state_none }}</div>
          </div>
            <input id="input-image" type="file" accept="image/*" name="properties[{{ tr_prop_image }}]" style="display:none;">
          </div>
        </div>
        {%- assign form_id = 'case-customizer-form-' | append: section.id -%}
        {%- form 'product', custom_product, id: form_id, class: 'form', novalidate: 'novalidate' -%}
          
          <input type="hidden" name="id" id="variant-id">
          <input type="hidden" name="properties[{{ tr_prop_image_x }}]" id="prop-image-x">
          <input type="hidden" name="properties[{{ tr_prop_image_y }}]" id="prop-image-y">
          <input type="hidden" name="properties[{{ tr_prop_image_scale }}]" id="prop-image-scale">
          <input type="hidden" name="properties[{{ tr_prop_fit_mode }}]" id="prop-fit-mode">
          <input type="hidden" name="properties[{{ tr_prop_rotation }}]" id="prop-image-rotation">
          <input type="hidden" name="properties[{{ tr_prop_text_x }}]" id="prop-text-x">
          <input type="hidden" name="properties[{{ tr_prop_text_y }}]" id="prop-text-y">
          <input type="hidden" name="properties[{{ tr_prop_text_size }}]" id="prop-text-size">
          <input type="hidden" name="properties[{{ tr_prop_text_color }}]" id="prop-text-color">
          <input type="hidden" name="properties[{{ tr_prop_sticker_name }}]" id="prop-sticker-name">
          <input type="hidden" name="properties[{{ tr_prop_sticker_x }}]" id="prop-sticker-x">
          <input type="hidden" name="properties[{{ tr_prop_sticker_y }}]" id="prop-sticker-y">
          <input type="hidden" name="properties[{{ tr_prop_sticker_scale }}]" id="prop-sticker-scale">
          <div><button type="submit" class="btn-primary">{{ tr_submit }}</button></div>
          <input type="hidden" id="data-area-left" value="{{ st.area_left }}">
          <input type="hidden" id="data-area-top" value="{{ st.area_top }}">
          <input type="hidden" id="data-area-width" value="{{ st.area_width }}">
          <input type="hidden" id="data-area-height" value="{{ st.area_height }}">
          <input type="hidden" name="properties[Case Color HEX]" id="prop-case-color">
          <input type="hidden" name="properties[Case Pattern Type]" id="prop-pattern-type">
          <input type="hidden" name="properties[Case Pattern Scale]" id="prop-pattern-scale">
          <input type="hidden" name="properties[Case Pattern Opacity]" id="prop-pattern-opacity">
          <input type="hidden" id="image-x" value="50">
          <input type="hidden" id="image-y" value="50">
          <input type="hidden" id="image-scale" value="100">
          <input type="hidden" id="image-rotation" value="0">
          <input type="hidden" id="input-text" value="">
          <input type="hidden" id="text-x" value="50">
          <input type="hidden" id="text-y" value="50">
          <input type="hidden" id="text-size" value="26">
          <input type="hidden" id="text-color" value="#111111">
          <input type="hidden" id="sticker-x" value="50">
          <input type="hidden" id="sticker-y" value="50">
          <input type="hidden" id="sticker-scale" value="100">
          <select id="fit-mode" style="display:none">
            <option value="cover">{{ tr_fit_mode_cover }}</option>
            <option value="contain">{{ tr_fit_mode_contain }}</option>
            <option value="stretch">{{ tr_fit_mode_stretch }}</option>
          </select>
          <input id="auto-fit" type="checkbox" checked style="display:none">
          <input id="clip-area" type="checkbox" checked style="display:none">
        {%- endform -%}
      </div>
    </div>
  </div>

  <script>
    (function() {
      var canvas = document.getElementById('customizer-canvas');
      var ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      var baseImg = new Image();
      baseImg.crossOrigin = 'anonymous';
      var maskImg = new Image();
      maskImg.crossOrigin = 'anonymous';
      var hasMask = false;
      var frameImg = new Image();
      frameImg.crossOrigin = 'anonymous';
      var hasFrame = false;
      var lastImgState = null;
      var imageMaps = [
        {%- for m in image_maps -%}
          {
            model: {{ m.settings.model_value | json }},
            type: {{ m.settings.case_type_value | json }},
            src: {{ m.settings.image | image_url: width: canvas_w | json }},
            mask: {{ m.settings.mask | image_url: width: canvas_w | json }},
            frame: {{ m.settings.frame | image_url: width: canvas_w | json }},
            left: {{ m.settings.area_left | default: st.area_left | json }},
            top: {{ m.settings.area_top | default: st.area_top | json }},
            width: {{ m.settings.area_width | default: st.area_width | json }},
            height: {{ m.settings.area_height | default: st.area_height | json }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ];
      var stickers = [
        {%- for s in stickers -%}
          {%- if s.settings.image != blank -%}
            { src: {{ s.settings.image | image_url: width: 600 | json }}, name: {{ s.settings.name | default: 'Sticker ' | append: forloop.index | json }} }
            {%- unless forloop.last -%},{%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      ];
      var areaLeftPct = parseFloat(document.getElementById('data-area-left').value || '10');
      var areaTopPct = parseFloat(document.getElementById('data-area-top').value || '10');
      var areaWidthPct = parseFloat(document.getElementById('data-area-width').value || '80');
      var areaHeightPct = parseFloat(document.getElementById('data-area-height').value || '80');
      var outsideAlpha = {{ outside_alpha | json }} / 100;
      var uploadInput = document.getElementById('input-image');
      var imgXInput = document.getElementById('image-x');
      var imgYInput = document.getElementById('image-y');
      var imgScaleInput = document.getElementById('image-scale');
      var textInput = document.getElementById('input-text');
      var textXInput = document.getElementById('text-x');
      var textYInput = document.getElementById('text-y');
      var textSizeInput = document.getElementById('text-size');
      var textColorInput = document.getElementById('text-color');
      var propImgX = document.getElementById('prop-image-x');
      var propImgY = document.getElementById('prop-image-y');
      var propImgScale = document.getElementById('prop-image-scale');
      var fitModeEl = document.getElementById('fit-mode');
      var autoFitEl = document.getElementById('auto-fit');
      var clipEl = document.getElementById('clip-area');
      var rotationEl = document.getElementById('image-rotation');
      var propFitMode = document.getElementById('prop-fit-mode');
      var propImageRotation = document.getElementById('prop-image-rotation');
      var palette = document.getElementById('palette');
      var colorHexInput = document.getElementById('color-hex');
      var propCaseColor = document.getElementById('prop-case-color');
      var patternGrid = document.getElementById('pattern-grid');
      var patternType = 'none';
      var progressBar = document.getElementById('progress-bar');
      var patternScaleInput = document.getElementById('pattern-scale');
      var patternOpacityInput = document.getElementById('pattern-opacity');
      var propPatternType = document.getElementById('prop-pattern-type');
      var propPatternScale = document.getElementById('prop-pattern-scale');
      var propPatternOpacity = document.getElementById('prop-pattern-opacity');
      var propTextX = document.getElementById('prop-text-x');
      var propTextY = document.getElementById('prop-text-y');
      var propTextSize = document.getElementById('prop-text-size');
      var propTextColor = document.getElementById('prop-text-color');
      var stickerXInput = document.getElementById('sticker-x');
      var stickerYInput = document.getElementById('sticker-y');
      var stickerScaleInput = document.getElementById('sticker-scale');
      var propStickerName = document.getElementById('prop-sticker-name');
      var propStickerX = document.getElementById('prop-sticker-x');
      var propStickerY = document.getElementById('prop-sticker-y');
      var propStickerScale = document.getElementById('prop-sticker-scale');
      var selectModel = document.getElementById('select-model');
      var selectType = document.getElementById('select-type');
      var variantIdInput = document.getElementById('variant-id');

      var uploadedImg = new Image();
      var hasUploaded = false;
      var stickerImg = new Image();
      var hasSticker = false;

      function setAreaByMap(map) {
        if (!map) return;
        areaLeftPct = parseFloat(map.left);
        areaTopPct = parseFloat(map.top);
        areaWidthPct = parseFloat(map.width);
        areaHeightPct = parseFloat(map.height);
      }

      function resolveBaseImage(model, type) {
        var match = imageMaps.find(function(m){ return m.model === model && m.type === type; });
        if (match) {
          baseImg.src = match.src;
          setAreaByMap(match);
          hasMask = !!match.mask;
          hasFrame = !!match.frame;
          if (hasMask) { maskImg.onload = requestDraw; maskImg.src = match.mask; } else { maskImg.src = ''; }
          if (hasFrame) { frameImg.onload = requestDraw; frameImg.src = match.frame; } else { frameImg.src = ''; }
          return;
        }
        var v = findVariantByOptions(model, type);
        if (v && v.featured_media && v.featured_media.preview_image && v.featured_media.preview_image.src) {
          baseImg.src = v.featured_media.preview_image.src;
          setAreaByMap({left: {{ st.area_left }}, top: {{ st.area_top }}, width: {{ st.area_width }}, height: {{ st.area_height }}});
          hasMask = false; hasFrame = false; maskImg.src = ''; frameImg.src = '';
          return;
        }
        baseImg.src = {{ fallback_image | image_url: width: canvas_w | json }};
        setAreaByMap({left: {{ st.area_left }}, top: {{ st.area_top }}, width: {{ st.area_width }}, height: {{ st.area_height }}});
        hasMask = false; hasFrame = false; maskImg.src = ''; frameImg.src = '';
      }

      var rafPending = false;
      function requestDraw(){ if (!rafPending) { rafPending = true; requestAnimationFrame(function(){ rafPending = false; draw(); }); } }
      var caseColor = '#2C3428';
      function hexToRgb(h){
        var s = h.replace('#','');
        var r = parseInt(s.substring(0,2),16);
        var g = parseInt(s.substring(2,4),16);
        var b = parseInt(s.substring(4,6),16);
        return { r:r, g:g, b:b };
      }
      function generatePatternCanvas(type, baseColor, scalePct){
        var pc = document.createElement('canvas');
        var base = 80;
        var s = Math.max(20, Math.round(base * (scalePct/100)));
        pc.width = s; pc.height = s;
        var pctx = pc.getContext('2d');
        pctx.clearRect(0,0,pc.width, pc.height);
        var rgb = hexToRgb(baseColor);
        var stroke = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+',0.25)';
        var fill = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+',0.15)';
        if (type === 'stripes') {
          pctx.fillStyle = fill;
          for (var i=0;i<pc.width;i+=Math.round(s/8)){ pctx.fillRect(i,0,Math.round(s/12),pc.height); }
        } else if (type === 'dots') {
          pctx.fillStyle = fill;
          for (var y=Math.round(s/10);y<pc.height;y+=Math.round(s/5)){
            for (var x=Math.round(s/10);x<pc.width;x+=Math.round(s/5)){ pctx.beginPath(); pctx.arc(x,y,Math.round(s/20),0,Math.PI*2); pctx.fill(); }
          }
        } else if (type === 'grid') {
          pctx.strokeStyle = stroke; pctx.lineWidth = 1;
          var step = Math.round(s/8);
          for (var gx=step; gx<pc.width; gx+=step){ pctx.beginPath(); pctx.moveTo(gx,0); pctx.lineTo(gx,pc.height); pctx.stroke(); }
          for (var gy=step; gy<pc.height; gy+=step){ pctx.beginPath(); pctx.moveTo(0,gy); pctx.lineTo(pc.width,gy); pctx.stroke(); }
        } else if (type === 'crosshatch') {
          pctx.strokeStyle = stroke; pctx.lineWidth = 1;
          var step2 = Math.round(s/10);
          for (var d=-pc.height; d<pc.width; d+=step2){ pctx.beginPath(); pctx.moveTo(d,0); pctx.lineTo(d+pc.height,pc.height); pctx.stroke(); }
          for (var d2=-pc.height; d2<pc.width; d2+=step2){ pctx.beginPath(); pctx.moveTo(d2,pc.height); pctx.lineTo(d2+pc.height,0); pctx.stroke(); }
        } else if (type === 'diagonal') {
          pctx.fillStyle = fill;
          var w = Math.round(s/10);
          for (var k=-pc.height; k<pc.width; k+=Math.round(s/6)){ pctx.save(); pctx.translate(k,0); pctx.rotate(45*Math.PI/180); pctx.fillRect(0,0,w,pc.height*1.5); pctx.restore(); }
        } else if (type === 'waves') {
          pctx.fillStyle = fill;
          var ry = Math.round(s/5), rx = Math.round(s/2.5), rad = Math.round(s/10);
          for (var wy=0; wy<pc.height; wy+=ry){
            for (var wx=0; wx<pc.width; wx+=rx){ pctx.beginPath(); pctx.arc(wx+Math.round(rad), wy+Math.round(rad), rad, Math.PI*0.5, Math.PI*1.5); pctx.arc(wx+Math.round(rad*3), wy+Math.round(rad), rad, Math.PI*1.5, Math.PI*0.5); pctx.closePath(); pctx.fill(); }
          }
        } else if (type === 'honeycomb') {
          pctx.strokeStyle = stroke; pctx.lineWidth = 1;
          var a = Math.round(s/6);
          var h = Math.round(Math.sin(Math.PI/3) * a);
          for (var y=0; y<pc.height + h; y+=h) {
            for (var x=0; x<pc.width + a; x+=a) {
              var ox = (Math.round(y/h)%2) ? Math.round(a/2) : 0;
              pctx.beginPath();
              pctx.moveTo(x+ox + a/2, y);
              pctx.lineTo(x+ox + a, y+h);
              pctx.lineTo(x+ox + a/2, y+2*h);
              pctx.lineTo(x+ox, y+h);
              pctx.closePath();
              pctx.stroke();
            }
          }
        } else if (type === 'checker') {
          var step = Math.round(s/4);
          for (var y=0; y<pc.height; y+=step){
            for (var x=0; x<pc.width; x+=step){
              var on = (((x/step) + (y/step)) % 2) === 0;
              pctx.fillStyle = on ? fill : 'transparent';
              pctx.fillRect(x,y,step,step);
            }
          }
        } else if (type === 'chevron') {
          pctx.strokeStyle = stroke; pctx.lineWidth = 2;
          var step = Math.round(s/5);
          for (var y=step; y<pc.height; y+=step){
            pctx.beginPath();
            pctx.moveTo(0,y);
            pctx.lineTo(s/2,y-step);
            pctx.lineTo(s,y);
            pctx.stroke();
          }
        } else if (type === 'herringbone') {
          pctx.fillStyle = fill;
          var step = Math.round(s/5);
          for (var y=0; y<pc.height; y+=step){
            for (var x=0; x<pc.width; x+=step){
              pctx.save();
              pctx.translate(x,y);
              pctx.rotate(((x/step)%2===0)? 45*Math.PI/180 : -45*Math.PI/180);
              pctx.fillRect(0,0,Math.round(step/2), step);
              pctx.restore();
            }
          }
        } else if (type === 'terrazzo') {
          var pieces = 12;
          for (var i=0;i<pieces;i++){
            var px = Math.random()*s, py = Math.random()*s;
            var pw = Math.random()*Math.round(s/4);
            var ph = Math.random()*Math.round(s/4);
            pctx.fillStyle = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+(0.1 + Math.random()*0.2)+')';
            pctx.beginPath();
            pctx.moveTo(px,py);
            pctx.lineTo(px+pw,py);
            pctx.lineTo(px+pw,py+ph);
            pctx.lineTo(px,py+ph);
            pctx.closePath();
            pctx.fill();
          }
        }
        return pc;
      }
      function draw() {
        var ratio = baseImg.width / baseImg.height || 1;
        var wrap = document.getElementById('preview-wrap');
        var cw = Math.min((wrap && wrap.clientWidth) || {{ canvas_w }}, {{ canvas_w }});
        canvas.width = cw;
        canvas.height = Math.round(canvas.width / ratio);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        ctx.save();
        ctx.strokeStyle = 'rgba(0,0,0,0.12)';
        ctx.setLineDash([6, 4]);
        ctx.lineWidth = 2;
        ctx.strokeRect(areaLeft, areaTop, areaW, areaH);
        ctx.restore();
        if (patternType && patternType !== 'none') {
          var scalePct = patternScaleInput ? parseFloat(patternScaleInput.value || '100') : 100;
          var tile = generatePatternCanvas(patternType, caseColor, scalePct);
          var pat = ctx.createPattern(tile, 'repeat');
          var pcomp = document.createElement('canvas');
          pcomp.width = Math.max(1, Math.round(areaW));
          pcomp.height = Math.max(1, Math.round(areaH));
          var pctx = pcomp.getContext('2d');
          pctx.fillStyle = pat;
          pctx.fillRect(0,0,pcomp.width,pcomp.height);
          if (hasMask && maskImg.width) {
            pctx.globalCompositeOperation = 'destination-in';
            pctx.drawImage(maskImg, 0, 0, pcomp.width, pcomp.height);
            pctx.globalCompositeOperation = 'source-over';
          }
          var pop = patternOpacityInput ? Math.max(0, Math.min(1, parseFloat(patternOpacityInput.value || '30')/100)) : 0.3;
          ctx.save();
          ctx.globalAlpha = pop;
          ctx.drawImage(pcomp, areaLeft, areaTop);
          ctx.restore();
        }
        if (caseColor && caseColor.length) {
          ctx.save();
          ctx.globalCompositeOperation = 'multiply';
          ctx.fillStyle = caseColor;
          ctx.fillRect(areaLeft, areaTop, areaW, areaH);
          ctx.restore();
        }
        if (hasUploaded && uploadedImg.width) {
        var imgPctX = imgXInput ? parseFloat(imgXInput.value || '50') : 50;
        var imgPctY = imgYInput ? parseFloat(imgYInput.value || '50') : 50;
        var imgScalePct = imgScaleInput ? parseFloat(imgScaleInput.value || '100') : 100;
          var aspect = uploadedImg.width / uploadedImg.height;
          var areaAspect = areaW / areaH;
          var mode = (fitModeEl && fitModeEl.value) || 'cover';
          propFitMode && (propFitMode.value = mode);

          var imgW, imgH;
          if (autoFitEl && autoFitEl.checked) {
            if (mode === 'contain') {
              if (aspect > areaAspect) { imgW = areaW; imgH = imgW / aspect; } else { imgH = areaH; imgW = imgH * aspect; }
            } else if (mode === 'cover') {
              if (aspect > areaAspect) { imgH = areaH; imgW = imgH * aspect; } else { imgW = areaW; imgH = imgW / aspect; }
            } else { imgW = areaW; imgH = areaH; }
            var computedScalePct = (imgW / areaW) * 100;
            imgScalePct = computedScalePct;
            imgScaleInput && (imgScaleInput.value = Math.round(computedScalePct));
            imgPctX = 50; imgPctY = 50;
            imgXInput && (imgXInput.value = 50);
            imgYInput && (imgYInput.value = 50);
          } else { imgW = areaW * (imgScalePct / 100); imgH = imgW / aspect; }

          var deg = rotationEl ? parseFloat(rotationEl.value || '0') : 0;
          propImageRotation && (propImageRotation.value = Math.round(deg));

          var comp = document.createElement('canvas');
          var compCtx = comp.getContext('2d');
          comp.width = Math.max(1, Math.round(areaW));
          comp.height = Math.max(1, Math.round(areaH));

          compCtx.clearRect(0, 0, comp.width, comp.height);
          compCtx.save();
          var lcX = comp.width * imgPctX / 100;
          var lcY = comp.height * imgPctY / 100;
          compCtx.translate(lcX, lcY);
          compCtx.rotate(deg * Math.PI / 180);
          compCtx.drawImage(uploadedImg, -imgW / 2, -imgH / 2, imgW, imgH);
          compCtx.restore();

          var absCX = areaLeft + lcX;
          var absCY = areaTop + lcY;
          lastImgState = { cx: absCX, cy: absCY, w: imgW, h: imgH, deg: deg, areaLeft: areaLeft, areaTop: areaTop, areaW: areaW, areaH: areaH };

          if (hasSticker && stickerImg.width) {
            var sxPct = parseFloat(stickerXInput.value || '50');
            var syPct = parseFloat(stickerYInput.value || '50');
            var ssPct = parseFloat(stickerScaleInput.value || '100');
            var sw = comp.width * (ssPct / 100);
            var sh = sw * (stickerImg.height / stickerImg.width);
            var scx = comp.width * sxPct / 100;
            var scy = comp.height * syPct / 100;
            compCtx.drawImage(stickerImg, scx - sw / 2, scy - sh / 2, sw, sh);
          }

          var textVal = textInput.value || '';
          if (textVal.length) {
            var txPct = parseFloat(textXInput.value || '50');
            var tyPct = parseFloat(textYInput.value || '50');
            var tSize = parseInt(textSizeInput.value || '26', 10);
            var tColor = textColorInput.value || '#111111';
            var tx = comp.width * txPct / 100;
            var ty = comp.height * tyPct / 100;
            compCtx.save();
            compCtx.fillStyle = tColor;
            compCtx.textAlign = 'center';
            compCtx.textBaseline = 'middle';
            compCtx.font = tSize + 'px sans-serif';
            compCtx.fillText(textVal, tx, ty);
            compCtx.restore();
            propTextX.value = txPct.toFixed(2);
            propTextY.value = tyPct.toFixed(2);
            propTextSize.value = tSize;
            propTextColor.value = tColor;
          }

          if (hasMask && maskImg.width) {
            compCtx.globalCompositeOperation = 'destination-in';
            compCtx.drawImage(maskImg, 0, 0, comp.width, comp.height);
            compCtx.globalCompositeOperation = 'source-over';
          } else if (clipEl && clipEl.checked) {
            compCtx.globalCompositeOperation = 'destination-in';
            var rectMask = document.createElement('canvas');
            rectMask.width = comp.width; rectMask.height = comp.height;
            var rm = rectMask.getContext('2d');
            rm.fillStyle = '#000'; rm.fillRect(0,0,comp.width, comp.height);
            compCtx.drawImage(rectMask, 0,0);
            compCtx.globalCompositeOperation = 'source-over';
          }

          if (outsideAlpha > 0) {
            ctx.save();
            ctx.globalAlpha = outsideAlpha;
            var imgXAbs = areaLeft + comp.width * imgPctX / 100 - imgW / 2;
            var imgYAbs = areaTop + comp.height * imgPctY / 100 - imgH / 2;
            var cx = imgXAbs + imgW / 2; var cy = imgYAbs + imgH / 2;
            ctx.translate(cx, cy);
            ctx.rotate(deg * Math.PI / 180);
            ctx.drawImage(uploadedImg, -imgW / 2, -imgH / 2, imgW, imgH);
            ctx.restore();
          }

          ctx.drawImage(comp, areaLeft, areaTop);

          if (hasFrame && frameImg.width) {
            ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
          }

          if (lastImgState) {
            var bb = lastImgState;
            var cos = Math.cos(bb.deg * Math.PI/180), sin = Math.sin(bb.deg * Math.PI/180);
            var corners = [
              { x: -bb.w/2, y: -bb.h/2 },
              { x: bb.w/2, y: -bb.h/2 },
              { x: bb.w/2, y: bb.h/2 },
              { x: -bb.w/2, y: bb.h/2 }
            ].map(function(p){ return { x: bb.cx + p.x * cos - p.y * sin, y: bb.cy + p.x * sin + p.y * cos }; });
            ctx.save();
            ctx.strokeStyle = 'rgba(17,17,17,0.35)';
            ctx.setLineDash([6, 4]);
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(corners[0].x, corners[0].y);
            for (var i=1;i<4;i++){ ctx.lineTo(corners[i].x, corners[i].y); }
            ctx.closePath();
            ctx.stroke();
            ctx.restore();
            var rotateHandle = { x: bb.cx + (0 * cos - (-bb.h/2 - 24) * sin), y: bb.cy + (0 * sin + (-bb.h/2 - 24) * cos) };
            var scaleHandle = { x: bb.cx + (bb.w/2 * cos - (-bb.h/2) * sin), y: bb.cy + (bb.w/2 * sin + (-bb.h/2) * cos) };
            ctx.save();
            ctx.fillStyle = '#fff'; ctx.strokeStyle = '#111'; ctx.lineWidth = 1.5;
            [rotateHandle, scaleHandle].forEach(function(h){ ctx.beginPath(); ctx.arc(h.x, h.y, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke(); });
            ctx.restore();
          }

          propImgX.value = imgPctX.toFixed(2);
          propImgY.value = imgPctY.toFixed(2);
          propImgScale.value = parseFloat(imgScalePct).toFixed(2);
        }
        var textVal = textInput.value || '';
        if (textVal.length) {
          var txPct = parseFloat(textXInput.value || '50');
          var tyPct = parseFloat(textYInput.value || '50');
          var tSize = parseInt(textSizeInput.value || '26', 10);
          var tColor = textColorInput.value || '#111111';
          var tx = areaLeft + areaW * txPct / 100;
          var ty = areaTop + areaH * tyPct / 100;
          ctx.save();
          ctx.fillStyle = tColor;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.font = tSize + 'px sans-serif';
          ctx.fillText(textVal, tx, ty);
          ctx.restore();
          propTextX.value = txPct.toFixed(2);
          propTextY.value = tyPct.toFixed(2);
          propTextSize.value = tSize;
          propTextColor.value = tColor;
        }
        if (hasSticker && stickerImg.width) {
          propStickerX.value = (parseFloat(stickerXInput.value || '50')).toFixed(2);
          propStickerY.value = (parseFloat(stickerYInput.value || '50')).toFixed(2);
          propStickerScale.value = (parseFloat(stickerScaleInput.value || '100')).toFixed(2);
        }
      }

      baseImg.onload = requestDraw;

      function findVariantByOptions(model, type) {
        var variants = {{ custom_product.variants | json }};
        var optNames = {{ custom_product.options | json }};
        var idxModel = optNames.indexOf({{ model_option_name | json }});
        var idxType = optNames.indexOf({{ type_option_name | json }});
        return variants.find(function(v){
          var ok = true;
          if (idxModel === 0 && v.option1 !== model) ok = false;
          if (idxModel === 1 && v.option2 !== model) ok = false;
          if (idxModel === 2 && v.option3 !== model) ok = false;
          if (idxType === 0 && v.option1 !== type) ok = false;
          if (idxType === 1 && v.option2 !== type) ok = false;
          if (idxType === 2 && v.option3 !== type) ok = false;
          return ok;
        }) || null;
      }

      function initSelectors() {
        var models = [];
        var types = [];
        imageMaps.forEach(function(m){
          if (m.model && models.indexOf(m.model) === -1) models.push(m.model);
          if (m.type && types.indexOf(m.type) === -1) types.push(m.type);
        });
        if (models.length === 0 || types.length === 0) {
          var opts = {{ custom_product.options_with_values | json }};
          var modelOpt = opts.find(function(o){ return o.name === {{ model_option_name | json }}; }) || { values: [] };
          var typeOpt = opts.find(function(o){ return o.name === {{ type_option_name | json }}; }) || { values: [] };
          models = modelOpt.values || [];
          types = typeOpt.values || [];
        }
        selectModel.innerHTML = models.map(function(v){ return '<option>'+v+'</option>'; }).join('');
        selectType.innerHTML = types.map(function(v){ return '<option>'+v+'</option>'; }).join('');
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
      }

      uploadInput.addEventListener('change', function(e) {
        var f = e.target.files && e.target.files[0];
        if (!f) return;
        var url = URL.createObjectURL(f);
        uploadedImg.onload = function() { hasUploaded = true; requestDraw(); };
        uploadedImg.src = url;
      });
      if (uploadInput) {
        uploadInput.addEventListener('change', function(){ if (imageState) { imageState.textContent = trImageSelected; } });
      }

      document.getElementById('sticker-list').addEventListener('click', function(e){
        var idx = e.target && e.target.dataset && e.target.dataset.sticker;
        if (idx == null) return;
        var item = stickers[parseInt(idx, 10)];
        if (!item) return;
        stickerImg.onload = function(){ hasSticker = true; requestDraw(); };
        stickerImg.src = item.src;
        propStickerName.value = item.name;
        Array.prototype.forEach.call(document.querySelectorAll('#sticker-list img'), function(img){ img.classList.remove('active'); });
        if (e.target && e.target.tagName === 'IMG') { e.target.classList.add('active'); }
      });

      [imgXInput, imgYInput, imgScaleInput, textInput, textXInput, textYInput, textSizeInput, textColorInput, stickerXInput, stickerYInput, stickerScaleInput, fitModeEl, autoFitEl, clipEl, rotationEl].forEach(function(el) {
        if (el) el.addEventListener('input', requestDraw);
      });

      var dragging = false;
      var dragStart = null;
      var startPct = { x: 50, y: 50 };
      var transforming = null;
      var transformStart = null;
      function near(p, q){ var dx=p.x-q.x, dy=p.y-q.y; return Math.sqrt(dx*dx+dy*dy) <= 12; }
      canvas.addEventListener('pointerdown', function(ev){
        if (!hasUploaded) return;
        var rect = canvas.getBoundingClientRect();
        var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        if (!lastImgState) return;
        var bb = lastImgState;
        var cos = Math.cos(bb.deg * Math.PI/180), sin = Math.sin(bb.deg * Math.PI/180);
        var rotateHandle = { x: bb.cx + (0 * cos - (-bb.h/2 - 24) * sin), y: bb.cy + (0 * sin + (-bb.h/2 - 24) * cos) };
        var scaleHandle = { x: bb.cx + (bb.w/2 * cos - (-bb.h/2) * sin), y: bb.cy + (bb.w/2 * sin + (-bb.h/2) * cos) };
        if (near({x:x,y:y}, rotateHandle)) {
          transforming = 'rotate';
          var curDeg = rotationEl ? parseFloat(rotationEl.value || '0') : 0;
          transformStart = { x: x, y: y, deg: curDeg };
        } else if (near({x:x,y:y}, scaleHandle)) {
          transforming = 'scale';
          var r0 = Math.sqrt((bb.w/2)*(bb.w/2) + (bb.h/2)*(bb.h/2));
          var rx = x - bb.cx, ry = y - bb.cy;
          var r = Math.sqrt(rx*rx + ry*ry);
          var curScale = imgScaleInput ? parseFloat(imgScaleInput.value || '100') : 100;
          transformStart = { r0: r0, r: r, scale: curScale };
        } else {
          if (x < areaLeft || x > areaLeft + areaW || y < areaTop || y > areaTop + areaH) return;
          dragging = true; dragStart = { x: x, y: y };
          startPct.x = imgXInput ? parseFloat(imgXInput.value || '50') : 50;
          startPct.y = imgYInput ? parseFloat(imgYInput.value || '50') : 50;
        }
        canvas.setPointerCapture(ev.pointerId);
      });
      canvas.addEventListener('pointermove', function(ev){
        if (!dragging && !transforming) return;
        var rect = canvas.getBoundingClientRect();
        var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
        var areaLeft = canvas.width * areaLeftPct / 100;
        var areaTop = canvas.height * areaTopPct / 100;
        var areaW = canvas.width * areaWidthPct / 100;
        var areaH = canvas.height * areaHeightPct / 100;
        if (transforming === 'rotate' && lastImgState) {
          var bb = lastImgState;
          var ang0 = Math.atan2((transformStart.y - bb.cy), (transformStart.x - bb.cx));
          var ang = Math.atan2((y - bb.cy), (x - bb.cx));
          var delta = (ang - ang0) * 180 / Math.PI;
          var nd = transformStart.deg + delta;
          if (rotationEl) rotationEl.value = Math.round(nd);
        } else if (transforming === 'scale' && lastImgState) {
          var rx = x - lastImgState.cx, ry = y - lastImgState.cy;
          var r = Math.sqrt(rx*rx + ry*ry);
          var ratio = r / Math.max(1, transformStart.r0);
          var nv = Math.max(10, Math.min(300, transformStart.scale * ratio));
          if (imgScaleInput) imgScaleInput.value = Math.round(nv);
        } else if (dragging) {
          var dx = x - dragStart.x; var dy = y - dragStart.y;
          var nx = Math.max(0, Math.min(100, startPct.x + (dx / areaW) * 100));
          var ny = Math.max(0, Math.min(100, startPct.y + (dy / areaH) * 100));
          if (imgXInput) imgXInput.value = nx.toFixed(2);
          if (imgYInput) imgYInput.value = ny.toFixed(2);
        }
        requestDraw();
      });
      canvas.addEventListener('pointerup', function(){ dragging = false; transforming = null; });
      canvas.addEventListener('pointercancel', function(){ dragging = false; transforming = null; });

      canvas.addEventListener('wheel', function(ev){
        if (!hasUploaded) return;
        ev.preventDefault();
        var v = parseFloat(imgScaleInput.value || '100');
        var step = ev.deltaY > 0 ? -5 : 5;
        var nv = Math.max(10, Math.min(300, v + step));
        imgScaleInput.value = nv;
        requestDraw();
      }, { passive: false });

      var touchScale = null;
      canvas.addEventListener('touchstart', function(ev){
        if (ev.touches && ev.touches.length === 2) {
          var dx = ev.touches[0].clientX - ev.touches[1].clientX;
          var dy = ev.touches[0].clientY - ev.touches[1].clientY;
          touchScale = Math.sqrt(dx*dx + dy*dy);
        } else { touchScale = null; }
      }, { passive: true });
      canvas.addEventListener('touchmove', function(ev){
        if (!hasUploaded) return;
        if (ev.touches && ev.touches.length === 2 && touchScale) {
          var dx = ev.touches[0].clientX - ev.touches[1].clientX;
          var dy = ev.touches[0].clientY - ev.touches[1].clientY;
          var cur = Math.sqrt(dx*dx + dy*dy);
          var v = parseFloat(imgScaleInput.value || '100');
          var nv = Math.max(10, Math.min(300, v * (cur / touchScale)));
          imgScaleInput.value = Math.round(nv);
          touchScale = cur;
          requestDraw();
          ev.preventDefault();
        }
      }, { passive: false });

      selectModel.addEventListener('change', function(){
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
        requestDraw();
      });
      selectType.addEventListener('change', function(){
        var m = selectModel.value;
        var t = selectType.value;
        var v = findVariantByOptions(m, t) || {{ custom_product.selected_or_first_available_variant | json }};
        variantIdInput.value = v.id;
        resolveBaseImage(m, t);
        requestDraw();
      });

      window.addEventListener('resize', requestDraw);
      document.addEventListener('visibilitychange', function(){ if (!document.hidden) requestDraw(); });

      baseImg.src = {{ fallback_image | image_url: width: canvas_w | json }};
      initSelectors();
      var tabBtns = document.querySelectorAll('.tab-btn');
      var tabViews = { model: document.getElementById('tab-model'), color: document.getElementById('tab-color'), pattern: document.getElementById('tab-pattern'), image: document.getElementById('tab-image') };
      var tabOrder = ['model','color','pattern','image'];
      var currentTab = 'model';
      function setTab(t){
        Array.prototype.forEach.call(tabBtns, function(b){ b.classList.toggle('active', b.dataset.tab === t); });
        Object.keys(tabViews).forEach(function(k){ tabViews[k].classList.toggle('active', k === t); });
        if (progressBar) {
          var pct = t === 'model' ? 25 : (t === 'color' ? 50 : (t === 'pattern' ? 75 : 100));
          progressBar.style.width = pct + '%';
        }
        currentTab = t;
        var backBtn = document.getElementById('btn-back');
        var nextBtn = document.getElementById('btn-next');
        var idx = tabOrder.indexOf(currentTab);
        if (backBtn) backBtn.disabled = idx <= 0;
        if (nextBtn) nextBtn.disabled = idx >= tabOrder.length - 1;
      }
      Array.prototype.forEach.call(tabBtns, function(b){ b.addEventListener('click', function(){ setTab(b.dataset.tab); }); });
      setTab('model');
      palette.addEventListener('click', function(e){
        var c = e.target && e.target.dataset && e.target.dataset.color;
        if (!c) return;
        caseColor = c;
        colorHexInput.value = c.toUpperCase();
        propCaseColor.value = c.toUpperCase();
        requestDraw();
      });
      colorHexInput.addEventListener('input', function(){
        var v = colorHexInput.value.trim();
        if (/^#?[0-9a-fA-F]{6}$/.test(v)) {
          if (v[0] !== '#') v = '#' + v;
          caseColor = v;
          propCaseColor.value = v.toUpperCase();
          requestDraw();
        }
      });
      if (patternGrid) {
        patternGrid.addEventListener('click', function(e){
          var p = e.target && e.target.dataset && e.target.dataset.pattern;
          if (!p) return;
          patternType = p;
          Array.prototype.forEach.call(document.querySelectorAll('#pattern-grid .pattern-swatch'), function(s){ s.classList.remove('active'); });
          if (e.target && e.target.classList) { e.target.classList.add('active'); }
          if (propPatternType) { propPatternType.value = p; }
          requestDraw();
        });
      }
      if (patternScaleInput) { patternScaleInput.addEventListener('input', function(){ if (propPatternScale) { propPatternScale.value = patternScaleInput.value; } requestDraw(); }); }
      if (patternOpacityInput) { patternOpacityInput.addEventListener('input', function(){ if (propPatternOpacity) { propPatternOpacity.value = patternOpacityInput.value; } requestDraw(); }); }
      var triggerUpload = document.getElementById('trigger-upload');
      var imageState = document.getElementById('image-state');
      if (triggerUpload) {
        triggerUpload.addEventListener('click', function(){ uploadInput && uploadInput.click(); });
      }
      var backBtn = document.getElementById('btn-back');
      var nextBtn = document.getElementById('btn-next');
      if (backBtn) { backBtn.addEventListener('click', function(){ var idx = tabOrder.indexOf(currentTab); if (idx > 0) setTab(tabOrder[idx-1]); }); }
      if (nextBtn) { nextBtn.addEventListener('click', function(){ var idx = tabOrder.indexOf(currentTab); if (idx < tabOrder.length-1) setTab(tabOrder[idx+1]); }); }
      var delBtn = document.getElementById('btn-delete-image');
      delBtn.addEventListener('click', function(){
        hasUploaded = false; uploadedImg = new Image(); uploadInput.value = '';
        propImgX.value=''; propImgY.value=''; propImgScale.value=''; rotationEl.value='0';
        requestDraw();
      });
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "手机壳定制",
  "settings": [
    { "type": "text", "id": "product_handle", "label": "商品句柄", "info": "要定制的手机壳商品句柄" },
    { "type": "text", "id": "model_option_name", "label": "型号选项名", "default": "型号" },
    { "type": "text", "id": "case_type_option_name", "label": "壳类型选项名", "default": "壳类型" },
    { "type": "image_picker", "id": "mockup_image", "label": "默认底图" },
    { "type": "range", "id": "outside_alpha", "label": "遮罩外预览不透明度", "min": 0, "max": 80, "step": 5, "default": 25, "unit": "%" },
    { "type": "range", "id": "canvas_width", "label": "画布宽度", "min": 300, "max": 1200, "step": 50, "default": 700, "unit": "px" },
    { "type": "range", "id": "area_left", "label": "可印刷区域 左", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
    { "type": "range", "id": "area_top", "label": "可印刷区域 上", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
    { "type": "range", "id": "area_width", "label": "可印刷区域 宽", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" },
    { "type": "range", "id": "area_height", "label": "可印刷区域 高", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" }
  ],
  "blocks": [
    {
      "type": "base_image_map",
      "name": "底图映射",
      "settings": [
        { "type": "text", "id": "model_value", "label": "型号值（如 iPhone 15）" },
        { "type": "text", "id": "case_type_value", "label": "壳类型值（如 透明/磨砂）" },
        { "type": "image_picker", "id": "image", "label": "底图" },
        { "type": "image_picker", "id": "mask", "label": "遮罩图（孔位/不可印刷处透明）" },
        { "type": "image_picker", "id": "frame", "label": "框架叠层图（提升真实感）" },
        { "type": "range", "id": "area_left", "label": "该组合 左偏移", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
        { "type": "range", "id": "area_top", "label": "该组合 上偏移", "min": 0, "max": 100, "step": 1, "default": 10, "unit": "%" },
        { "type": "range", "id": "area_width", "label": "该组合 区域宽度", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" },
        { "type": "range", "id": "area_height", "label": "该组合 区域高度", "min": 10, "max": 100, "step": 1, "default": 80, "unit": "%" }
      ]
    },
    {
      "type": "sticker",
      "name": "贴纸",
      "settings": [
        { "type": "text", "id": "name", "label": "贴纸名称", "default": "贴纸" },
        { "type": "image_picker", "id": "image", "label": "贴纸图片" }
      ]
    }
  ],
  "presets": [
    { "name": "手机壳定制" }
  ]
}
{% endschema %}
      var trImageSelected = {{ tr_image_state_selected | json }};
      var trImageNone = {{ tr_image_state_none | json }};